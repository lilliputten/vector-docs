> $Id: local-dev-server.md 10433 2018-08-01 12:21:46Z miheev $
> $Date: 2018-08-01 15:21:46 +0300 (Ср, 01 авг 2018) $

Локальный сервер разработчика
=============================

Локальный сервер может использоваться в двух режимах:

- Standalone enb-server: "голый" enb-сервер. Вместо реальных данных используются накопленные демо-данные (fake-data, см. [Эмуляция и накопление данных от сервера приложения](fake-data.md)).
- Эмуляция реального окружения сервера с помощью nginx. Все запросы данных и ресурсов перенапрвляются к локальному enb-серверу.

При первом обращении в зависимости от адреса запроса (точнее, от порта: для
nginx используется 5590, см. параметр конфигурации `NGINX_PORT` в
`project__root.js` и `WEB_TINTS/source/.enb/make.js`; в последнем см. ещё и
проверку порта в структуре данных `__global.enbServerRequest.headers.host` --
для того, чтобы получить к ней доступ, должен быть применён патч из
`WEB_TINTS/source/!Patches/enb-server`) определяется, проходит ли запрос через серевер nginx.

Независимо от необходимости работы с nginx или standalone-enb-server запуск сервера производится любой из команд:

- `node run -s server`,
- `enb server` (если enb установлен и пропатчен глобально).

> (ВОПРОС: Возможно, надо запускать сервер с переменной окружения или
> параметром, явно указывающим, какой режим необходимо исопльзовать?)

В случае работы из-под nginx происходит прозрачаная для приложения
переадресация ресурсов на enb-сервер.

В противном случае (включён режим DEBUG и установлена переменная
`USE_ENB_URLS`) все пути запросов ресурсов заменяются на локальные (см.
подстановки в `project__config.js`; выбрасываются при обработки директив
`DEBUG*` при постпроцессинге).

Пример формирования корневного пути запросов:
```javascript
    rootUrl = /*DEBUG*/USE_ENB_URLS ? enbRoot :
        '../',
```

Фрагмент настроек редиректов на enb-сервер из конфигурации nginx:
```nginx
    # Перекидываем динамику к enb серверу...
    # Описание содержания страниц
    location ~* ^/WEB_TINTS/(?:release/)*core/js/bemjson/(\w+).json$ {
      proxy_pass http://127.0.0.1:8080/pages/$1/$1.json;
    }
    # Разметка страницы приложения
    location ~* ^/WEB_TINTS/(?:release/)*core/(app|app.debug).html(.*)$ {
      proxy_pass http://127.0.0.1:8080/pages/App/App.html$2;
    }
    # Сброки css|browser|bemhtml для рабочих экранов (версии '.stylesx.css', '.browserx.js', '.bemhtmlx.js')
    location ~* ^/WEB_TINTS/(?:release/)*core/(js|css)/bem/([^\.\/]*)\.(styles|browser|bemhtml)(?:\.min)*\.((?:css|js).*)$ {
      proxy_pass http://127.0.0.1:8080/pages/$2/$2.$3x.$4;
    }
```

См. [полный файл конфигурации nginx](local-dev-server-nginx.conf).

