> $Id: make.md 10430 2018-08-01 10:43:07Z miheev $
> $Date: 2018-08-01 13:43:07 +0300 (Ср, 01 авг 2018) $

Процедура сборки и конфигурация
===============================

Основная сборка и вспомогательные задачи запускаются с помощью поточного
сборщика gulp:

`gulp {target}`

Отдельные задачи (частичная сборка, тесты, линтинг, запуск сервера, очистка
могут выполняться при помощи отдельных консольных команд.

Вызовы `gulp` могут производиться из менеджера npm и из удалённого скрипта
`remote.php`:

- `npm run -s make`
- `http://youcomp.geyser.ru:8082/WEB_TINTS/remote.php?make`
- `http://185.41.41.90:8082/WEB_TINTS/remote.php?make`

Конфигурация
------------

- `WEB_TINTS/source/gulpfile.config.yaml` -- Конфигурация gulp.
- `WEB_TINTS/source/gulpfile.js` -- Управляющий скрипт gulp.

Список команд gulp
------------------

### Вспомогательные/низкоуровневые задачи

- `init` -- Копирование статических ресурсов.
- `make` (`bem`) -- Низкоуровневая сборка -- запуск `enb make` с переменной окружения `YENV=inject`.
- `inject` -- Подготовка и установка сгененрированных файлов.

### Сборка

- `all` (`regenerate`) -- Очистить и пересобрать всё, включая библиотки (последовательность `init`, `bem`, `inject`)
- `remake` (`default`) -- Очистить и пересобрать всё, кроме библиотек (последовательность `bem`, `inject`). Основная команда, если в статических файлах ничего не менялось.

### Очистка

- `cleanAll` -- Очистить всё.
- `cleanBem` -- Удалить сгенерированные при enb-сборке файлы. См. переменную конфигурации gulpfile `PAGES_PATH`.
- `cleanCache` -- Очистка кеша phalcon. См. переменную конфигурации gulpfile `CACHE_FILES`.
- `cleanFakeData` -- Очищаем накопленные для эмуляции сервера приложений при локальной разработке данные. См. переменную конфигурации gulpfile `FAKE_DATA_PATH`.
- `cleanInit` -- Очистка статических файлов. См. переменную конфигурации gulpfile `CLEAN_INIT_FILES`.
- `cleanInject` -- Удаление установленной сборки. См. переменные конфигурации gulpfile `APP_TARGET_NAME`, `APP_TARGET_EXT`, `CLEAN_INJECT_FILES`.
- `cleanLogs` -- Очистка логов phalcon. См. переменную конфигурации gulpfile `LOGS_FILES`.
- `cleanStable` -- Удаление папки stable-версии. См. переменную конфигурации gulpfile `STABLE_PATH`.

### Прочие

- `bootstrapJs` -- Пересобрать js для библиоткеи bootstrap в соответствии с заданным списком файлов.
- `stable` -- Создание стабильной версии проекта (froze). См. переменную конфигурации gulpfile `STABLE_PATH`.
- `tags` -- Создать список тегов (ctags). Используется внешняя команда `gulp-javascript-ctags`.

Список команд для удалённого скрипта `remote.php`
-------------------------------------------------

- `all` -- Перегенерить всё (`gulp all`).
- `cleanCache` -- Очистка данных приложения (php/phalcon).
- `clean` -- Очистить файлы сборщика, временные файлы, тестовые данные (осторожно! как минимум надо будет перегенирить проект!).
- `cleanup` -- Очистить состояние svn (`svn cleanup`).
- `commit` -- Синхронизировать изменения на сервере с репозиторием svn (сделать коммит).
- `lint` -- Запустить проверку.
- `log` -- Показать лог svn.
- `redis_flush` -- очистка кеша redis.
- `remake` -- Перегенерить без копирования статики (без gulp init) `gulp remake`.
- `stable` -- Создать stable-версию проекта.
- `test` -- Проверка работоспособности (выводит лог svn с одной последней записью и текст "ok").
- `tests` -- Запустить тесты (на сервере не работает!).
- `update` -- Обновить из svn.

Процесс сборки
--------------

Сборка производится в два этапа:

- Сборка bem-проекта. Команда `gulp make`. См. [Сборка bem-проекта, сборщик enb](enb-make.md)
- Постобработка сгенерированных файлов и установка в целевые папки. Команда `gulp inject.`

В составных задачах перед сборкой выполняется очистка целевых папок.

### Постобработка

Во время выполнения команды `inject` (`gulp inject` или в составе
комплексных `gulp remake` или `gulp all`) происходит дополнительная обработка
файлов пакетов (styles, browser, bemhtml).

Выполняются задачи:

- "Препроцессинг" (в осовном `DEBUG*/NO-DEBUG` макросы).
- Создание `.min.*` версий файлов пакетов. Если установлен флаг конфигурации
  gulp `UGLIFY_MIN_ASSETS`, то производится обфускация (если не установлен, то
  файлы `.min.*` являются копией исходных файлов -- в таком случае
  принудительная обфускация производится при создании stable-версии).

### Установка в целевые папки

В соответствии с параметрами конфигурации (`gulpfile.config.yaml`) установка сгенерированных файлов производится в следующие папки:

- Точка входа в приложение -- файлы `WEB_TINTS/release/core/app{.debug}.html`.
- Bemjson файлов пакетов (`*.json`) -- файлы `WEB_TINTS/release/core/js/bemjson/*.json`.
- Клиентские скрипты (`*.browser*.js`) -- файлы `WEB_TINTS/release/core/js/bem/*.browser{.min}.js`.
- Bemhtml шаблоны (`*.bemhtml*.js`) -- файлы `WEB_TINTS/release/core/js/bem/*.bemhtml{.min}.js`.
- Стили (`*.styles*.css`) -- файлы `WEB_TINTS/release/core/css/bem/*.styles{.min}.css`

