>
> $Id: single-page-app.md 10409 2018-07-25 17:23:46Z miheev $
>
> $Date: 2018-07-25 20:23:46 +0300 (Ср, 25 июл 2018) $
>

Одностраничная архитектура приложения
=====================================

Основные принципы
-----------------

- Оптимизация нагрузки на сервер (общий трафик, количество запросов).
- Полная (?) генерация контента на клиенте без передачи статического контента
  (передаём только данные, их описание, возможно -- шаблоны или описания
  элементов интерфейса).
- Кеширование запросов/данных.
- Переиспользование данных.
- Запрос данных по необходимости.
- Минимизация использования составных данных (отказ от сборки на сервере).
  (???)

Общая структура приложения
--------------------------

Приложение является контейнером, предоставляющим инфраструктуру для
взаимодействия с сервером, хранения данных, показа информации пользователю.

Приложение имеет набор собственных настроечных данных, часть из которых
передаётся до его инициализации (с первым запросом, `get_AppParams_`). Все
пользовательские данные запрашиваются уже после разворачивания базовой
инфрастуктуры посредством асинхронных запросов, если пройдена авторизация. За
авторизацию отвечает модуль `SecureAjax` (разрабатывается С.А., используется
как "чёрный ящик"). Если авторизация не пройдена, то вместо ответа на запрос
`get_AppParams_` приложению возвращается ошибка (пользователь видит это
сообщение на форме, в которой его снова приглашают к авторизации).

Элементы интерфейса могут быть постоянными (служебными, "статичными"?) и
динамическими. Например, общая шапка страницы (экрана) не нуждается в
постоянной перегенерации; можно обновлять отдельные её элементы (иконки
статуса, содержимое блока logon/userInfo после авторизации пользователя).
Динамический элемент присутствует, как минимум, один: основная рабочая область
работы с системой.

Рабочая область создаётся из пакета `App`, содержащего основной код, стили и
шаблоны системы. Прочие пакеты подгружаются по мере необходимости (зависимости
описываются в конфигурации страницы). Сейчас (на 2018.07.25) имеются два
дополнительных пакета: `Report` (для генерации отчётов) и `MapView` (показ
карты).

Смена страниц ("экранов") приложения происходит без перезагрузки самого
контейнера: обновляем рабочую область, используя нужный шаблон или статический
фрагмент (способ разворачивания задаётся в описании страниц; чаще всего
используется код шаблона bemjson/bemhtml).

До тех пор, пока не была произведена авторизация, система не получает никаких
чувствительных данных и по сути не работоспособна.

Если был совершён выход из системы, то кешированные данные и вся полученная
информация сбрасывются, т.е. система приводится в состояние "не
авторизировано".

Кеширование
-----------

Разделение данных (в частности, словарей) по времени жизни и получение разными
запросами с разными настройками кеширования.

Обеспечение минимального кеширования обычных `ajax/get` запросов. (Отказ от
парметров в запросах?)

Запрос данных по необходимости
------------------------------

По возможности пытаться избежать загрузки данных, без которых можно обойтись,
-- до появления необходимости в них. Кешироваться могут запрашиваемые словари
(см. параметры метода `app:load_dicts_queue_request`) и отдельные ресурсы (см.
параметры метода `app:load_asset`).

Реализация
----------

Весь код, обеспечивающий цикл SPA пока содержится в блоке app. В будущем
необходимо разделить его на модули, выделив составные части:

- Собственно SPA (загрузка и разворачивание страниц, поддержка сессии, сокетов).
- Контроллер ресурсов (пакетов).
- Контроллер словарей.

Необходим рефакторинг и упрощение кода загрузки словарей/ресурсов и
разворачивания страниц.

Структура меню
--------------

Описание меню содержится в файле `WEB_TINTS/release/core/scripts/php/app-config/appmenu.php`.

В переменной `$_CONSTANTS['appdata']['menu']` создаётся иерархическое описание структуры меню:
```php
$_CONSTANTS['appdata']['menu'] = [
    // Приложение
    'appId' => [
        // Меню верхнего уровня
        [ 'title' => 'Отчёты', 'content' => [
            // Пункт меню
            [ 'title' => 'Периоды движения (рабочий)', 'id' => 'tcm_Reports_detailmove' ],
            // Подменю
            [ 'title' => 'Оперативные отчёты', 'content' => [
                // Пункты подменю...
            ] ],
            // Другие пункты...
        ] ],
        // Другие меню верхнего уровня...
    ],
    // Другие приложения...
];
```

Описание страниц
----------------

Описания страниц содержится в файлах, разложенных по папкам `WEB_TINTS/release/core/scripts/php/app-config/*`.

Для каждой страницы создаётся файл, имя которого совпадает с ID страницы (напр., `tcm_Monitoring_KO.php`).

Из каких папок собирать описания, указано в файле
`WEB_TINTS/release/core/scripts/php/app-config/appdata.php` (вызовы вида
`loadPagesFolder('tcm');` загружают все описания из папки `tcm`).

В итоге все описания собираются в плоском списке `$_CONSTANTS['appdata']['pages']`.

Описания страниц могут иметь следующий вид:
```php
$_CONSTANTS['appdata']['pages']['AdminKO'] = [
    'setPageReadyWaiter' => true, // Ждать от страницы сигнала о завершении: `waiter.finish('pageReady')`
    'title' => 'Администрирование КО', // Название страницы
    'required' => [
        // Список словарей для предзагрузки (обычно не используется)
        'dicts' => [
            // 'objTypes',
            // 'objTypesBrief',
            // 'objTypesCodes',
            // 'ControlArea',
            // 'CarType',
            // 'CarModel',
        ],
        // Необходимые для загрузки ресурсы
        'assets' => [
            [ 'type' => 'package', 'kind' => 'styles.css', 'name' => 'AdminKO' ],
            [ 'type' => 'package', 'kind' => 'bemhtml.js', 'name' => 'AdminKO' ],
            [ 'type' => 'package', 'kind' => 'browser.js', 'name' => 'AdminKO' ],
            [ 'type' => 'data', 'url' => '{{bemjson}}AdminKO.json' ],
            // [ 'type' => 'script', 'url' => 'js/bem-test/test.js' ],
            // [ 'type' => 'style', 'url' => 'css/bem-test/test.css' ],
        ],
    ],
    // Способ разворачивания страницы (в данном случае -- из загруженного ранее ресурса `{{bemjson}}AdminKO.json`).
    'open' => [
        'bemhtml' => 'data:{{bemjson}}AdminKO.json',
        // Варианты:
        // 'bemhtml' => 'data:<bemhtmlResuorceId>', // Идентификатор ресурса данных объекта для генерации в html
        // 'bemhtml' => '<bemhtmlDataObject>', // Raw-данные объекта для генерации в html
        // 'html' => 'data:<htmlResuorceId>', // Идентификатор загруженного html-контента
        // 'html' => '<htmlString>', // Html строка: "сырой" код html
        // 'html' => [ '<htmlString>', ... ], // Список html строк
        // 'extend' => $extendData, // Данные для дополнения описания страницы (в случае для `bemhtml`) перед генерацией из него html -- служит для кастомизации страницы.
    ]
];
```

Рендер страницы производится в методе `app:_openPageRender`.

В большинстве случаев достаточно воспользоваться одним из вспомгательных
методов создания страниц, описанных в виде глобальных функций в файле
`WEB_TINTS/release/core/scripts/php/app-config/apptools.php`:

- `createBundlePage`: Для создания страницы на основе конкретного пакета.
  Напр.: `createBundlePage('MapView', 'tcm_Monitoring_KO', 'Мониторинг КО');`
  См., напр.,
  `WEB_TINTS/release/core/scripts/php/app-config/tcm/tcm_Monitoring_KO.php`.

- `createReportPage`: Для создания страницы отчёта (на основе пакета `Report`).
  Напр.: `createReportPage('tcm_Reports_areavisit', 'areavisit', 'Отчет по
  посещению зон контроля');`. См. файл
  `WEB_TINTS/release/core/scripts/php/app-config/tcm/tcm_Reports_areavisit.php`.

- `createFakePage`: Для создания фейк-страницы. Напр.:
  `createFakePage('tcm_Monitoring_KO_FAKE', 'Мониторинг КО (вариант)',
  '{{coreUrl}}fake-pages/tcm/tcm_Monitoring_KO.html');`

